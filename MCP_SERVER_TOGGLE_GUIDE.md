# 🎛️ MCP Server & Toolkit Toggle Guide

## Overview

Your Composio proxy now supports **complete control** over which MCP servers and toolkits are enabled for use in Open WebUI. This allows you to:

1. **Turn on/off entire MCP servers** (from your Composio dashboard)
2. **Enable/disable specific toolkits** (like GitHub, Gmail, Slack, etc.)
3. **Control tool visibility** directly from Open WebUI interface
4. **Minimize token usage** by showing only relevant tools

## 🚀 Quick Setup

### 1. Add Tool Connection in Open WebUI

**Settings → Tools → Add Tool Connection:**
- **Name**: `Composio MCP Tools`
- **URL**: `https://your-railway-app.railway.app/openapi.tools.json?mode=generic`
- **Authentication**: `Bearer your_composio_api_key`
- **Save and Refresh**

This creates a single generic endpoint that keeps token usage minimal while providing access to all your enabled tools.

## 🎛️ Server & Toolkit Management

### List Your MCP Servers

**GET** `/openapi/mcp/servers`

```bash\ncurl -H \"Authorization: Bearer your_api_key\" \\\n     \"https://your-proxy.railway.app/openapi/mcp/servers\"\n```

**Response Example:**\n```json\n{\n  \"items\": [\n    {\n      \"id\": \"server-123\",\n      \"name\": \"My Gmail Server\",\n      \"toolkits\": [\"gmail\", \"googlecalendar\"],\n      \"status\": \"active\"\n    },\n    {\n      \"id\": \"server-456\", \n      \"name\": \"Development Tools\",\n      \"toolkits\": [\"github\", \"notion\", \"slack\"],\n      \"status\": \"active\"\n    }\n  ]\n}\n```\n\n### Enable Specific MCP Servers\n\n**POST** `/openapi/mcp/servers/allowed`\n\n```bash\ncurl -X POST \\\n     -H \"Authorization: Bearer your_api_key\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"servers\": [\"server-123\", \"server-456\"]}' \\\n     \"https://your-proxy.railway.app/openapi/mcp/servers/allowed\"\n```\n\n**This enables:**\n- Only tools from the specified servers\n- All toolkits within those servers (gmail, googlecalendar, github, notion, slack)\n- Filters out all other servers and their tools\n\n### List Available Toolkits\n\n**GET** `/openapi/toolkits`\n\n```bash\ncurl -H \"Authorization: Bearer your_api_key\" \\\n     \"https://your-proxy.railway.app/openapi/toolkits\"\n```\n\n**Response:**\n```json\n{\n  \"toolkits\": [\"github\", \"gmail\", \"notion\", \"slack\", \"googlecalendar\"],\n  \"server_toolkit_map\": {\n    \"github\": [{\"id\": \"server-456\", \"name\": \"Development Tools\"}],\n    \"gmail\": [{\"id\": \"server-123\", \"name\": \"My Gmail Server\"}]\n  }\n}\n```\n\n### Enable Specific Toolkits\n\n**POST** `/openapi/toolkits/allowed`\n\n```bash\ncurl -X POST \\\n     -H \"Authorization: Bearer your_api_key\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"toolkits\": [\"github\", \"gmail\"]}' \\\n     \"https://your-proxy.railway.app/openapi/toolkits/allowed\"\n```\n\n**This enables:**\n- Only GitHub and Gmail tools\n- Hides Notion, Slack, Google Calendar, etc.\n- Perfect for focused workflows\n\n## 🎯 Usage Scenarios\n\n### Scenario 1: Enable Only Work Tools\n\n```bash\n# Enable work-related toolkits only\ncurl -X POST \\\n     -H \"Authorization: Bearer $API_KEY\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"toolkits\": [\"github\", \"notion\", \"slack\"]}' \\\n     \"$PROXY_URL/openapi/toolkits/allowed\"\n```\n\n### Scenario 2: Personal Assistant Mode\n\n```bash\n# Enable personal toolkits\ncurl -X POST \\\n     -H \"Authorization: Bearer $API_KEY\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"toolkits\": [\"gmail\", \"googlecalendar\", \"googledocs\"]}' \\\n     \"$PROXY_URL/openapi/toolkits/allowed\"\n```\n\n### Scenario 3: Enable Specific Server\n\n```bash\n# Enable only one MCP server and all its toolkits\ncurl -X POST \\\n     -H \"Authorization: Bearer $API_KEY\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"servers\": [\"server-123\"]}' \\\n     \"$PROXY_URL/openapi/mcp/servers/allowed\"\n```\n\n### Scenario 4: Reset to All Tools\n\n```bash\n# Clear all filters (enable everything)\ncurl -X POST \\\n     -H \"Authorization: Bearer $API_KEY\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"servers\": []}' \\\n     \"$PROXY_URL/openapi/mcp/servers/allowed\"\n     \ncurl -X POST \\\n     -H \"Authorization: Bearer $API_KEY\" \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"toolkits\": []}' \\\n     \"$PROXY_URL/openapi/toolkits/allowed\"\n```\n\n## 🔧 Integration with Open WebUI\n\n### Method 1: Direct API Calls (Recommended)\n\nUse the proxy's management endpoints directly from your browser console or scripts:\n\n```javascript\n// In browser console while on Open WebUI\nconst proxyUrl = \"https://your-proxy.railway.app\";\nconst apiKey = \"your_composio_api_key\";\n\n// Enable only GitHub tools\nfetch(`${proxyUrl}/openapi/toolkits/allowed`, {\n  method: 'POST',\n  headers: {\n    'Authorization': `Bearer ${apiKey}`,\n    'Content-Type': 'application/json'\n  },\n  body: JSON.stringify({toolkits: ['github']})\n})\n.then(r => r.json())\n.then(console.log);\n```\n\n### Method 2: Custom Open WebUI Functions\n\nCreate custom functions in Open WebUI that call the management endpoints:\n\n```python\ndef enable_work_tools():\n    \"\"\"Enable work-related Composio tools only\"\"\"\n    import requests\n    \n    response = requests.post(\n        \"https://your-proxy.railway.app/openapi/toolkits/allowed\",\n        headers={\"Authorization\": \"Bearer your_api_key\"},\n        json={\"toolkits\": [\"github\", \"notion\", \"slack\"]}\n    )\n    return f\"Work tools enabled: {response.json()}\"\n```\n\n## 📊 Monitoring & Status\n\n### Check Current Settings\n\n```bash\n# Check enabled servers\ncurl -H \"Authorization: Bearer $API_KEY\" \\\n     \"$PROXY_URL/openapi/mcp/servers/allowed\"\n\n# Check enabled toolkits  \ncurl -H \"Authorization: Bearer $API_KEY\" \\\n     \"$PROXY_URL/openapi/toolkits/allowed\"\n\n# List available tools (filtered)\ncurl -H \"Authorization: Bearer $API_KEY\" \\\n     \"$PROXY_URL/api/tools\" | jq '.count'\n```\n\n### Debug Tool Visibility\n\nIf tools aren't appearing in Open WebUI:\n\n1. **Check server status:**\n   ```bash\n   curl \"$PROXY_URL/openapi/mcp/servers/allowed\"\n   ```\n\n2. **Check toolkit settings:**\n   ```bash\n   curl \"$PROXY_URL/openapi/toolkits/allowed\"\n   ```\n\n3. **Verify tool count:**\n   ```bash\n   curl -H \"Authorization: Bearer $API_KEY\" \"$PROXY_URL/api/tools\" | jq '.count'\n   ```\n\n4. **Check proxy logs** in Railway dashboard for filtering activity\n\n## 🎛️ Filtering Priority\n\nThe proxy applies filters in this order:\n\n1. **Server Filter** - If servers are specified, only tools from those servers\n2. **Toolkit Filter** - If toolkits are specified, only tools from those toolkits\n3. **Legacy Apps Filter** - For backward compatibility\n\n**Example:**\n- Enabled servers: `[\"server-123\"]` (has GitHub, Gmail)\n- Enabled toolkits: `[\"github\"]`\n- **Result:** Only GitHub tools from server-123 are visible\n\n## ⚡ Performance Benefits\n\n### Token Savings\n- **Before:** 2000+ tools in context → 402 errors\n- **After:** 10-50 relevant tools → smooth operation\n\n### Faster Loading\n- **Generic mode:** Single endpoint, minimal OpenAPI spec\n- **Filtered tools:** Faster aggregation and caching\n- **Connection pooling:** Reused connections to Composio API\n\n## 🚨 Important Notes\n\n1. **Settings are in-memory** - They reset when the proxy restarts\n2. **Both server and toolkit filters** can be active simultaneously\n3. **Empty arrays clear filters** - `{\"servers\": []}` enables all servers\n4. **Case-insensitive matching** - `\"GitHub\"` and `\"github\"` work the same\n5. **Real-time effect** - Changes apply immediately to new tool requests\n\n## 🛠️ Advanced Usage\n\n### Dynamic Toolkit Switching\n\nCreate bookmarklets or browser extensions that quickly switch between toolkit sets:\n\n```javascript\n// Bookmarklet for \"Focus Mode\" (GitHub only)\njavascript:(function(){\n  fetch('https://your-proxy.railway.app/openapi/toolkits/allowed', {\n    method: 'POST',\n    headers: {'Authorization': 'Bearer your_key', 'Content-Type': 'application/json'},\n    body: JSON.stringify({toolkits: ['github']})\n  }).then(r=>r.json()).then(d=>alert('Focus mode: ' + d.toolkits));\n})();\n```\n\n### Workflow-Based Automation\n\n```bash\n#!/bin/bash\n# workflow-switch.sh\n\ncase $1 in\n  \"work\")\n    curl -X POST -H \"Authorization: Bearer $API_KEY\" -H \"Content-Type: application/json\" \\\n         -d '{\"toolkits\": [\"github\", \"notion\", \"slack\"]}' \\\n         \"$PROXY_URL/openapi/toolkits/allowed\"\n    ;;\n  \"personal\")\n    curl -X POST -H \"Authorization: Bearer $API_KEY\" -H \"Content-Type: application/json\" \\\n         -d '{\"toolkits\": [\"gmail\", \"googlecalendar\"]}' \\\n         \"$PROXY_URL/openapi/toolkits/allowed\"\n    ;;\n  \"all\")\n    curl -X POST -H \"Authorization: Bearer $API_KEY\" -H \"Content-Type: application/json\" \\\n         -d '{\"servers\": [], \"toolkits\": []}' \\\n         \"$PROXY_URL/openapi/toolkits/allowed\"\n    ;;\nesac\n```\n\n**Usage:** `./workflow-switch.sh work`\n\n## ✅ Success Verification\n\nYou'll know it's working when:\n\n1. **Open WebUI Tools tab** shows only your enabled toolkits\n2. **Invoke tool** calls work for enabled tools, fail for disabled ones\n3. **Proxy logs** show filter activity:\n   ```\n   INFO - Updated enabled toolkits: ['github', 'notion']\n   INFO - Fetched 45 tools from 2 apps in 0.83s\n   ```\n4. **Token usage drops** significantly in longer conversations\n\nYour Composio MCP server and toolkit toggle system is now fully operational! 🎉
